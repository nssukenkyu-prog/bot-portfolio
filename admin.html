<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®¡ç†ç”»é¢ - Portfolio Manager</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body class="admin-page">
    <nav class="top-nav">
        <a href="portfolio.html" class="nav-back">â† ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªã«æˆ»ã‚‹</a>
        <h1 class="nav-title">ğŸ” ç®¡ç†ç”»é¢ (Firebase)</h1>
        <div class="nav-right">
            <button id="logout-btn" class="nav-logout" style="display: none;">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
        </div>
    </nav>

    <div id="auth-section" class="auth-section">
        <div class="auth-card">
            <div class="auth-icon">ğŸ”’</div>
            <h2>ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³</h2>
            <p class="auth-subtitle">Firebaseã«ç™»éŒ²ã—ãŸæƒ…å ±ã‚’å…¥åŠ›</p>
            <form id="login-form">
                <input type="email" id="email" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹" required>
                <input type="password" id="password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" required>
                <button type="submit" class="btn-primary">ãƒ­ã‚°ã‚¤ãƒ³</button>
            </form>
            <p id="auth-error" class="error-message"></p>
        </div>
    </div>

    <div id="admin-content" class="container" style="display: none;">
        <div class="admin-panel">
            <h2>âœ¨ æ–°ã—ã„ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’è¿½åŠ </h2>
            <form id="add-form" class="project-form">
                <div class="form-row">
                    <div class="form-group">
                        <label>ã‚¿ã‚¤ãƒˆãƒ« *</label>
                        <input type="text" name="title" required placeholder="ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå" />
                    </div>
                    <div class="form-group">
                        <label>Boté¸æŠ *</label>
                        <select name="bot">
                            <option value="yuzu">ğŸš´â€â™‚ï¸ Yuzu bot</option>
                            <option value="kedo">ğŸ”¥ Kedo bot</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>èª¬æ˜</label>
                    <textarea name="description" rows="3" placeholder="èª¬æ˜æ–‡"></textarea>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>ã‚«ãƒ†ã‚´ãƒªãƒ¼</label>
                        <select name="platform">
                            <option value="GAS">GAS</option>
                            <option value="GitHub">GitHub</option>
                            <option value="Cloudflare">Cloudflare</option>
                            <option value="Genspark">Genspark</option>
                            <option value="Vercel">Vercel</option>
                            <option value="Other">ãã®ä»–</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ã‚¿ã‚° (ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Š)</label>
                        <input type="text" name="tags" placeholder="ä¾‹: GAS, TypeScript" />
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>å…¬é–‹URL *</label>
                        <input type="url" name="url" required placeholder="https://..." />
                    </div>
                    <div class="form-group">
                        <label>ç·¨é›†URL (ä»»æ„)</label>
                        <input type="url" name="editUrl" placeholder="https://..." />
                    </div>
                </div>

                <div class="form-group">
                    <label>ã‚µãƒ ãƒã‚¤ãƒ«ç”»åƒURL</label>
                    <input type="url" name="thumbnail" placeholder="Google Driveã®ãƒªãƒ³ã‚¯ãªã©" />
                </div>

                <button type="submit" class="btn-primary">è¿½åŠ ã™ã‚‹</button>
            </form>
        </div>

        <div class="admin-panel">
            <h2>ğŸ“‹ ç™»éŒ²æ¸ˆã¿ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ</h2>
            <div id="admin-projects-list" class="admin-list"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // â– â– â–  è¨­å®šã‚¨ãƒªã‚¢ (portfolio.htmlã¨åŒã˜ã‚‚ã®ã‚’è²¼ã‚‹) â– â– â– 
        const firebaseConfig = {
            apiKey: "AIzaSyDxxxxxxxxxxxxxxxxxxxxxxx",
            authDomain: "portfolio-db.firebaseapp.com",
            projectId: "portfolio-db",
            storageBucket: "portfolio-db.appspot.com",
            messagingSenderId: "123456789",
            appId: "1:123456789:web:xxxxxxxxxxxx"
        };
        // â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– 

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†
        const loginForm = document.getElementById('login-form');
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const errorEl = document.getElementById('auth-error');
            
            try {
                await signInWithEmailAndPassword(auth, email, password);
                errorEl.textContent = '';
            } catch (error) {
                errorEl.textContent = 'ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—: ' + error.message;
            }
        });

        // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå‡¦ç†
        document.getElementById('logout-btn').addEventListener('click', () => {
            signOut(auth);
        });

        // èªè¨¼çŠ¶æ…‹ã®ç›£è¦–
        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.getElementById('auth-section').style.display = 'none';
                document.getElementById('admin-content').style.display = 'block';
                document.getElementById('logout-btn').style.display = 'block';
                loadAdminProjects();
            } else {
                document.getElementById('auth-section').style.display = 'flex';
                document.getElementById('admin-content').style.display = 'none';
                document.getElementById('logout-btn').style.display = 'none';
            }
        });

        // ãƒ‡ãƒ¼ã‚¿è¿½åŠ 
        document.getElementById('add-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());
            
            // è¿½åŠ æ—¥æ™‚ã‚’ä¿å­˜ï¼ˆä¸¦ã³æ›¿ãˆç”¨ï¼‰
            data.createdAt = new Date().toISOString();

            try {
                await addDoc(collection(db, "projects"), data);
                alert('âœ¨ è¿½åŠ ã—ã¾ã—ãŸï¼');
                e.target.reset();
                loadAdminProjects();
            } catch (error) {
                alert('ã‚¨ãƒ©ãƒ¼: ' + error.message);
            }
        });

        // ä¸€è¦§å–å¾—
        async function loadAdminProjects() {
            const listEl = document.getElementById('admin-projects-list');
            listEl.innerHTML = '<p>èª­ã¿è¾¼ã¿ä¸­...</p>';
            
            try {
                const q = query(collection(db, "projects"), orderBy("createdAt", "desc")); // æ–°ã—ã„é †
                const querySnapshot = await getDocs(q); // ã‚¨ãƒ©ãƒ¼ãŒå‡ºã‚‹å ´åˆã¯ orderBy ã‚’å¤–ã™
                
                if (querySnapshot.empty) {
                    listEl.innerHTML = '<p>ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                    return;
                }

                let html = '';
                querySnapshot.forEach((doc) => {
                    const p = doc.data();
                    html += `
                        <div class="admin-item">
                            <div class="admin-item-info">
                                <h3>${p.title} <span style="font-size:0.8em; color:#666">(${p.bot})</span></h3>
                                <p>${p.description || ''}</p>
                            </div>
                            <div class="admin-item-actions">
                                <button class="btn-delete" data-id="${doc.id}">å‰Šé™¤</button>
                            </div>
                        </div>
                    `;
                });
                listEl.innerHTML = html;

                // å‰Šé™¤ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
                document.querySelectorAll('.btn-delete').forEach(btn => {
                    btn.addEventListener('click', async () => {
                        if(confirm('æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                            await deleteDoc(doc(db, "projects", btn.dataset.id));
                            alert('å‰Šé™¤ã—ã¾ã—ãŸ');
                            loadAdminProjects();
                        }
                    });
                });

            } catch (error) {
                console.error(error);
                // ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚¨ãƒ©ãƒ¼å›é¿ã®ãŸã‚ã€å˜ç´”å–å¾—ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
                if(error.message.includes("index")) {
                    const snapshot = await getDocs(collection(db, "projects"));
                    // ... (åŒã˜è¡¨ç¤ºå‡¦ç†)
                    alert('åˆå›ã®ãŸã‚ä¸¦ã³æ›¿ãˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒä½œæˆã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ã—ã°ã‚‰ãã™ã‚‹ã¨æ²»ã‚Šã¾ã™ã€‚');
                }
                listEl.innerHTML = 'èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼';
            }
        }
    </script>
</body>
</html>
