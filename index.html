<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Portfolio</title>
    <link rel="stylesheet" href="styles.css">
</head>

<body class="portfolio-page">
    <nav class="top-nav">
        <h1 class="nav-title">üöÄ Projects Portfolio</h1>
        <div class="nav-right">
            <a href="admin.html" class="nav-admin">üîê ÁÆ°ÁêÜÁîªÈù¢</a>
        </div>
    </nav>

    <div class="container">
        <div class="filter-section" id="filter-section">
        </div>

        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p>„Éá„Éº„Çø„ÇíÂèñÂæó‰∏≠...</p>
        </div>
        <div id="projects-grid" class="projects-grid"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // ‚ñ†‚ñ†‚ñ† FirebaseË®≠ÂÆö ‚ñ†‚ñ†‚ñ†
        const firebaseConfig = {
            apiKey: "AIzaSyDQuSOlOynAMMtBhBNBoGNHToN6QL-qkX4",
            authDomain: "portfolio-db-5df49.firebaseapp.com",
            projectId: "portfolio-db-5df49",
            storageBucket: "portfolio-db-5df49.firebasestorage.app",
            messagingSenderId: "587043981242",
            appId: "1:587043981242:web:e74d3edb165569f0913f83",
            measurementId: "G-RDGM3YC3G4"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let projectsData = [];
        let categoriesData = [];
        let platformsData = {};

        async function init() {
            const loading = document.getElementById('loading');
            try {
                // 1. „Ç´„ÉÜ„Ç¥„É™„Éº„Å®„Éó„É©„ÉÉ„Éà„Éï„Ç©„Éº„É†„Çí‰∏¶ÂàóÂèñÂæó
                const [catSnap, platSnap, projSnap] = await Promise.all([
                    getDocs(query(collection(db, "categories"), orderBy("order"))),
                    getDocs(collection(db, "platforms")),
                    getDocs(query(collection(db, "projects"), orderBy("createdAt", "desc")))
                ]);

                // „Ç´„ÉÜ„Ç¥„É™„ÉºÊï¥ÁêÜ
                categoriesData = [];
                catSnap.forEach(doc => categoriesData.push({ id: doc.id, ...doc.data() }));

                // „Éó„É©„ÉÉ„Éà„Éï„Ç©„Éº„É†Êï¥ÁêÜ (ID„ÅßÂºï„Åë„Çã„Çà„ÅÜ„Å´MapÂåñ)
                platformsData = {};
                platSnap.forEach(doc => platformsData[doc.id] = doc.data());

                // „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÊï¥ÁêÜ
                projectsData = [];
                projSnap.forEach(doc => projectsData.push({ id: doc.id, ...doc.data() }));

                // sort and assign indices
                projectsData.sort((a, b) => (a.order || 999) - (b.order || 999));
                const catCounts = {};
                projectsData.forEach((p, i) => {
                    p._globalIndex = i + 1;
                    if (!catCounts[p.categoryId]) catCounts[p.categoryId] = 0;
                    catCounts[p.categoryId]++;
                    p._catIndex = catCounts[p.categoryId];
                });

                renderFilters();
                displayProjects('all');
                loading.style.display = 'none';

            } catch (e) {
                console.error(e);
                loading.innerHTML = `<p class="error-message">Ë™≠„ÅøËæº„Åø„Ç®„É©„Éº: ${e.message}</p>`;
            }
        }

        // „Éï„Ç£„É´„Çø„Éº„Éú„Çø„É≥ÊèèÁîª
        function renderFilters() {
            const container = document.getElementById('filter-section');
            let html = `<button class="filter-btn active" onclick="filterProjects('all')">„Åô„Åπ„Å¶</button>`;

            categoriesData.forEach(cat => {
                html += `<button class="filter-btn" onclick="filterProjects('${cat.id}')">${cat.name}</button>`;
            });
            container.innerHTML = html;
        }

        // „Éï„Ç£„É´„Çø„É™„É≥„Ç∞Ê©üËÉΩ („Ç∞„É≠„Éº„Éê„É´)
        window.filterProjects = (catId) => {
            // „Éú„Çø„É≥„ÅÆË¶ã„ÅüÁõÆÊõ¥Êñ∞
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            displayProjects(catId);
        };

        // „Éó„É≠„Ç∏„Çß„ÇØ„ÉàË°®Á§∫
        function displayProjects(filterCatId) {
            const grid = document.getElementById('projects-grid');

            // „Éï„Ç£„É´„Çø„É™„É≥„Ç∞
            const targets = filterCatId === 'all'
                ? projectsData
                : projectsData.filter(p => p.categoryId === filterCatId);

            if (targets.length === 0) {
                grid.innerHTML = '<div class="no-projects"><p>„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p></div>';
                return;
            }

            grid.innerHTML = targets.map(p => {
                const deployPlatform = platformsData[p.deployPlatformId || p.platformId] || { name: 'Unknown', color: '#ccc' };
                const codePlatform = platformsData[p.codePlatformId] || null;
                const thumbUrl = convertGoogleDriveUrl(p.thumbnail);
                const hasLp = !!p.url;
                const hasSheet = !!p.spreadsheetUrl;
                const hasEdit = !!p.editUrl;
                const hasForm = !!p.formUrl;
                const hasAnyLink = hasLp || hasSheet || hasEdit || hasForm;

                return `
                <div class="project-card">
                    <div class="project-thumbnail">
                        ${thumbUrl
                        ? `<img src="${thumbUrl}" alt="${p.title}" onerror="this.parentElement.innerHTML='<div class=\\'thumbnail-placeholder\\'>üìÑ</div>'">`
                        : `<div class="thumbnail-placeholder">üìÑ</div>`}
                        <div class="thumbnail-overlay">
                            ${codePlatform ? `<span class="platform-badge" style="background:${codePlatform.color}">${codePlatform.name}</span>` : ''}
                            <span class="platform-badge" style="background:${deployPlatform.color}">${deployPlatform.name}</span>
                        </div>
                    </div>
                    <div class="project-content">
                        <div class="project-header-row" style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:0.5rem;">
                            <div class="project-meta" style="margin-bottom:0;">
                                ${p.creators
                        ? p.creators.map(c => `<span class="creator-badge">üë§ ${c}</span>`).join('')
                        : `<span class="creator-badge">üë§ ${p.creator || '-'}</span>`}
                            </div>
                            ${p.releaseDate ? `<span class="release-date" style="font-size:0.85rem; color:#64748b;">${p.releaseDate}</span>` : ''}
                        </div>
                        <h3>
                            <span class="display-id">No.${p._globalIndex} <span style="font-size:0.8em;opacity:0.7;">(No.${p._catIndex})</span></span>
                            ${p.title}
                        </h3>
                        <p class="project-description">${p.description || ''}</p>
                        
                        ${p.tags ? `<div class="project-tags">${p.tags.split(',').map(t => `<span class="tag">${t}</span>`).join('')}</div>` : ''}

                        <div class="project-links">
                            ${hasLp ? `
                                <a href="${p.url}" target="_blank" class="project-link project-link-view">
                                    <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor"><path d="M8.636 3.5a.5.5 0 0 0-.5-.5H1.5A1.5 1.5 0 0 0 0 4.5v10A1.5 1.5 0 0 0 1.5 16h10a1.5 1.5 0 0 0 1.5-1.5V7.864a.5.5 0 0 0-1 0V14.5a.5.5 0 0 1-.5.5h-10a.5.5 0 0 1-.5-.5v-10a.5.5 0 0 1 .5-.5h6.636a.5.5 0 0 0 .5-.5z"/><path d="M16 .5a.5.5 0 0 0-.5-.5h-5a.5.5 0 0 0 0 1h3.793L6.146 9.146a.5.5 0 1 0 .708.708L15 1.707V5.5a.5.5 0 0 0 1 0v-5z"/></svg>
                                    „Çµ„Ç§„Éà„ÇíÈñã„Åè
                                </a>
                            ` : ''}

                            ${hasForm ? `
                                <a href="${p.formUrl}" target="_blank" class="project-link project-link-form" style="background-color: #7248B9; color: white;">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:4px"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-7"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                                    „Éï„Ç©„Éº„É†
                                </a>
                            ` : ''}

                            ${hasSheet ? `
                                <a href="${p.spreadsheetUrl}" target="_blank" class="project-link project-link-sheet" style="background-color: #1D6F42; color: white;">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:4px"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="3" y1="9" x2="21" y2="9"></line><line x1="3" y1="15" x2="21" y2="15"></line><line x1="9" y1="3" x2="9" y2="21"></line></svg>
                                    „Ç∑„Éº„Éà
                                </a>
                            ` : ''}
                            
                            ${hasEdit ? `
                                <a href="${p.editUrl}" target="_blank" class="project-link project-link-edit">
                                    <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor"><path d="M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708l-10 10a.5.5 0 0 1-.168.11l-5 2a.5.5 0 0 1-.65-.65l2-5a.5.5 0 0 1 .11-.168l10-10zM11.207 2.5 13.5 4.793 14.793 3.5 12.5 1.207 11.207 2.5zm1.586 3L10.5 3.207 4 9.707V10h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.293l6.5-6.5zm-9.761 5.175-.106.106-1.528 3.821 3.821-1.528.106-.106A.5.5 0 0 1 5 12.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.468-.325z"/></svg>
                                    Á∑®ÈõÜÁîªÈù¢
                                </a>
                            ` : ''}

                            ${!hasAnyLink ? `
                                <span class="project-link disabled">
                                    <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor"><path d="M8 1a2 2 0 0 1 2 2v4H6V3a2 2 0 0 1 2-2zm3 6V3a3 3 0 0 0-6 0v4a2 2 0 0 0-2 2v5a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2z"/></svg>
                                    „É™„É≥„ÇØ„Å™„Åó (ÂÜÖÈÉ®„ÉÑ„Éº„É´)
                                </span>
                            ` : ''}
                        </div>
                    </div>
                </div>`;
            }).join('');
        }

        function convertGoogleDriveUrl(url) {
            if (!url) return '';
            const driveMatch = url.match(/\/file\/d\/([a-zA-Z0-9_-]+)/);
            if (driveMatch) return `https://drive.google.com/thumbnail?id=${driveMatch[1]}&sz=w800`;
            const idMatch = url.match(/[?&]id=([a-zA-Z0-9_-]+)/);
            if (idMatch) return `https://drive.google.com/thumbnail?id=${idMatch[1]}&sz=w800`;
            return url;
        }

        init();
    </script>
</body>

</html>