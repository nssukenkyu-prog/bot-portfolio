<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Portfolio</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body class="portfolio-page">

    <div id="lock-screen">
        <div class="lock-card">
            <div class="lock-icon">ğŸ”’</div>
            <h2>Secret Portfolio</h2>
            <p style="color:#666">é–²è¦§ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p>
            <form id="lock-form">
                <input type="password" id="lock-password" class="lock-input" placeholder="Password" required>
                <button type="submit" class="btn-primary" style="width:100%">è§£é™¤ã™ã‚‹</button>
            </form>
            <p id="lock-error" class="lock-error"></p>
        </div>
    </div>

    <div id="main-content" style="display: none;">
        <nav class="top-nav">
            <h1 class="nav-title">ğŸš€ Projects Portfolio</h1>
            <div class="nav-right">
                <a href="admin.html" class="nav-admin">ğŸ” ç®¡ç†ç”»é¢</a>
                <button id="viewer-logout-btn" class="nav-logout" style="margin-left:10px; font-size:0.8rem;">Exit</button>
            </div>
        </nav>

        <div class="container">
            <div class="filter-section" id="filter-section"></div>

            <div id="loading" class="loading">
                <div class="spinner"></div>
                <p>ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­...</p>
            </div>

            <div id="projects-grid" class="projects-grid"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        // Authæ©Ÿèƒ½ã‚’è¿½åŠ 
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // â– â– â–  Firebaseè¨­å®š (ã‚ãªãŸã®ã‚‚ã®ã‚’è²¼ã£ã¦ãã ã•ã„) â– â– â– 
        const firebaseConfig = {
            apiKey: "AIzaSyDQuSOlOynAMMtBhBNBoGNHToN6QL-qkX4",
            authDomain: "portfolio-db-5df49.firebaseapp.com",
            projectId: "portfolio-db-5df49",
            storageBucket: "portfolio-db-5df49.firebasestorage.app",
            messagingSenderId: "587043981242",
            appId: "1:587043981242:web:e74d3edb165569f0913f83",
            measurementId: "G-RDGM3YC3G4"
        };
        // â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– 

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app); // AuthåˆæœŸåŒ–
        const db = getFirestore(app);

        // â–¼â–¼â–¼ èªè¨¼ãƒ­ã‚¸ãƒƒã‚¯ â–¼â–¼â–¼
        
        // é–²è¦§ç”¨ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ (ã‚¹ãƒ†ãƒƒãƒ—1ã§ä½œã£ãŸã‚‚ã®)
        const VIEWER_EMAIL = "guest@portfolio.com";

        // ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã®ç›£è¦–
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ãªã‚‰ç”»é¢ã‚’è¡¨ç¤º
                document.getElementById('lock-screen').style.display = 'none';
                document.getElementById('main-content').style.display = 'block';
                init(); // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿é–‹å§‹
            } else {
                // æœªãƒ­ã‚°ã‚¤ãƒ³ãªã‚‰ãƒ­ãƒƒã‚¯ç”»é¢ã‚’è¡¨ç¤º
                document.getElementById('lock-screen').style.display = 'flex';
                document.getElementById('main-content').style.display = 'none';
            }
        });

        // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰é€ä¿¡æ™‚ã®å‡¦ç†
        document.getElementById('lock-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const password = document.getElementById('lock-password').value;
            const errorEl = document.getElementById('lock-error');
            
            errorEl.textContent = "èªè¨¼ä¸­...";

            try {
                // Firebase Auth ã§æœ¬å½“ã«ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹
                await signInWithEmailAndPassword(auth, VIEWER_EMAIL, password);
                // æˆåŠŸã™ã‚‹ã¨ onAuthStateChanged ãŒåå¿œã—ã¦ç”»é¢ãŒåˆ‡ã‚Šæ›¿ã‚ã‚Šã¾ã™
            } catch (error) {
                console.error(error);
                errorEl.textContent = "ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™";
                document.getElementById('lock-password').value = "";
            }
        });

        // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆï¼ˆExitï¼‰ãƒœã‚¿ãƒ³
        document.getElementById('viewer-logout-btn').addEventListener('click', () => {
            signOut(auth);
            location.reload();
        });
        // â–²â–²â–² èªè¨¼ãƒ­ã‚¸ãƒƒã‚¯ã“ã“ã¾ã§ â–²â–²â–²


        // ãƒ‡ãƒ¼ã‚¿ä¿æŒç”¨
        let projectsData = [];
        let categoriesData = [];
        let platformsData = {};

        async function init() {
            const loading = document.getElementById('loading');
            const grid = document.getElementById('projects-grid');

            try {
                const [catSnap, platSnap, projSnap] = await Promise.all([
                    getDocs(query(collection(db, "categories"), orderBy("order"))),
                    getDocs(collection(db, "platforms")),
                    getDocs(query(collection(db, "projects"), orderBy("createdAt", "desc")))
                ]);

                categoriesData = [];
                catSnap.forEach(doc => categoriesData.push({ id: doc.id, ...doc.data() }));

                platformsData = {};
                platSnap.forEach(doc => platformsData[doc.id] = doc.data());

                projectsData = [];
                projSnap.forEach(doc => projectsData.push({ id: doc.id, ...doc.data() }));

                // ä¸¦ã³æ›¿ãˆ
                projectsData.sort((a, b) => {
                    const orderA = a.order === undefined ? 999 : a.order;
                    const orderB = b.order === undefined ? 999 : b.order;
                    return orderA - orderB;
                });

                renderFilters();
                displayProjects('all');
                loading.style.display = 'none';

            } catch (e) {
                console.error(e);
                // æ¨©é™ã‚¨ãƒ©ãƒ¼ã®å ´åˆ
                if(e.code === 'permission-denied') {
                    alert('æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                    signOut(auth); // å¼·åˆ¶ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
                }
                loading.innerHTML = `<p class="error-message">èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼<br>${e.message}</p>`;
            }
        }

        function renderFilters() {
            const container = document.getElementById('filter-section');
            let html = `<button class="filter-btn active" onclick="filterProjects('all')">ã™ã¹ã¦</button>`;
            categoriesData.forEach(cat => {
                html += `<button class="filter-btn" onclick="filterProjects('${cat.id}')">${cat.name}</button>`;
            });
            container.innerHTML = html;
        }

        window.filterProjects = (catId) => {
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            displayProjects(catId);
        };

        function displayProjects(filterCatId) {
            const grid = document.getElementById('projects-grid');
            const targets = filterCatId === 'all' 
                ? projectsData 
                : projectsData.filter(p => p.categoryId === filterCatId);

            if (targets.length === 0) {
                grid.innerHTML = '<div class="no-projects"><p>ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</p></div>';
                return;
            }

            grid.innerHTML = targets.map(p => {
                const platform = platformsData[p.platformId] || { name: 'Unknown', color: '#ccc' };
                const hasLink = !!p.url;

                return `
                <div class="project-card">
                    <div class="project-card-inner">
                        <div class="project-main-content">
                            <div class="project-header">
                                <span class="creator-badge">ğŸ‘¤ ${p.creator}</span>
                                <h3>${p.title}</h3>
                            </div>
                            <div class="project-body-row">
                                <div class="project-platform-area">
                                    <div class="doc-icon">ğŸ“„</div>
                                    <span class="platform-badge" style="background-color: ${platform.color}">${platform.name}</span>
                                </div>
                                <p class="project-description">${p.description || ''}</p>
                            </div>
                            <div class="project-links-area">
                                ${hasLink ? `
                                    <a href="${p.url}" target="_blank" class="project-link">
                                        <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" style="margin-right:4px"><path d="M8.636 3.5a.5.5 0 0 0-.5-.5H1.5A1.5 1.5 0 0 0 0 4.5v10A1.5 1.5 0 0 0 1.5 16h10a1.5 1.5 0 0 0 1.5-1.5V7.864a.5.5 0 0 0-1 0V14.5a.5.5 0 0 1-.5.5h-10a.5.5 0 0 1-.5-.5v-10a.5.5 0 0 1 .5-.5h6.636a.5.5 0 0 0 .5-.5z"/><path d="M16 .5a.5.5 0 0 0-.5-.5h-5a.5.5 0 0 0 0 1h3.793L6.146 9.146a.5.5 0 1 0 .708.708L15 1.707V5.5a.5.5 0 0 0 1 0v-5z"/></svg>
                                        ã‚µã‚¤ãƒˆã‚’é–‹ã
                                    </a>
                                ` : `
                                    <span class="project-link disabled">ãƒªãƒ³ã‚¯ãªã—</span>
                                `}
                                ${p.editUrl ? `<a href="${p.editUrl}" target="_blank" class="project-link-edit">ç·¨é›†</a>` : ''}
                            </div>
                        </div>
                        <div class="project-side-content">
                            <div class="thumbnail-placeholder-side">ğŸ“„</div>
                            ${p.tags ? `
                                <div class="project-tags">
                                    ${p.tags.split(',').map(t => `<span class="tag">${t.trim()}</span>`).join('')}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>`;
            }).join('');
        }
    </script>
</body>
</html>
