<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Portfolio</title>
    <link rel="stylesheet" href="styles.css">
</head>

<body class="portfolio-page">

    <div id="lock-screen">
        <div class="lock-card">
            <div class="lock-icon">ğŸ”’</div>
            <h2>Secret Portfolio</h2>
            <p style="color:#666">é–²è¦§ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p>
            <form id="lock-form">
                <input type="password" id="lock-password" class="lock-input" placeholder="Password" required>
                <button type="submit" class="btn-primary" style="width:100%">è§£é™¤ã™ã‚‹</button>
            </form>
            <p id="lock-error" class="lock-error"></p>
            <div style="margin-top:2rem; border-top:1px solid #eee; padding-top:1rem;">
                <a href="admin.html" style="color:#94a3b8; text-decoration:none; font-size:0.9rem;">ğŸ” ç®¡ç†ç”»é¢ã¸ç§»å‹•</a>
            </div>
        </div>
    </div>

    <div id="main-content" style="display: none;">
        <nav class="top-nav">
            <h1 class="nav-title">ğŸš€ Projects Portfolio</h1>
            <div class="nav-right">
                <a href="admin.html" class="nav-admin">ğŸ” ç®¡ç†ç”»é¢</a>
            </div>
        </nav>

        <div class="container">
            <div class="filter-section" id="filter-section"></div>

            <div id="loading" class="loading">
                <div class="spinner"></div>
                <p>ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­...</p>
            </div>

            <div id="projects-grid" class="projects-grid"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // â– â– â–  Firebaseè¨­å®š â– â– â– 
        const firebaseConfig = {
            apiKey: "AIzaSyDQuSOlOynAMMtBhBNBoGNHToN6QL-qkX4",
            authDomain: "portfolio-db-5df49.firebaseapp.com",
            projectId: "portfolio-db-5df49",
            storageBucket: "portfolio-db-5df49.firebasestorage.app",
            messagingSenderId: "587043981242",
            appId: "1:587043981242:web:e74d3edb165569f0913f83",
            measurementId: "G-RDGM3YC3G4"
        };
        // â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– 

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // â–¼ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰èªè¨¼ï¼ˆJavaScriptç°¡æ˜“èªè¨¼ï¼‰
        const CORRECT_PASS = "scc62625353";

        document.getElementById('lock-form').addEventListener('submit', (e) => {
            e.preventDefault();
            if (document.getElementById('lock-password').value === CORRECT_PASS) {
                // ãƒ­ãƒƒã‚¯è§£é™¤
                document.getElementById('lock-screen').style.display = 'none';
                document.getElementById('main-content').style.display = 'block';
                // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿é–‹å§‹
                init();
            } else {
                document.getElementById('lock-error').textContent = "ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™";
            }
        });

        // â–¼ ãƒ‡ãƒ¼ã‚¿ä¿æŒç”¨å¤‰æ•°
        let projectsData = [], categoriesData = [], platformsData = {};

        // â–¼ åˆæœŸåŒ–ãƒ»ãƒ‡ãƒ¼ã‚¿å–å¾—å‡¦ç†
        async function init() {
            const loading = document.getElementById('loading');
            try {
                // ä¸¦ã³æ›¿ãˆãªã—ã§å…¨ä»¶å–å¾— (ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚¨ãƒ©ãƒ¼å›é¿ã®ãŸã‚)
                const [catSnap, platSnap, projSnap] = await Promise.all([
                    getDocs(collection(db, "categories")),
                    getDocs(collection(db, "platforms")),
                    getDocs(collection(db, "projects"))
                ]);

                // ã‚«ãƒ†ã‚´ãƒªãƒ¼æ•´ç†
                categoriesData = [];
                catSnap.forEach(doc => categoriesData.push({ id: doc.id, ...doc.data() }));
                categoriesData.sort((a, b) => (a.order || 0) - (b.order || 0));

                // ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ æ•´ç†
                platformsData = {};
                platSnap.forEach(doc => platformsData[doc.id] = doc.data());

                // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ•´ç†
                projectsData = [];
                projSnap.forEach(doc => projectsData.push({ id: doc.id, ...doc.data() }));

                // 1. Assign Creation-Based IDs (Oldest = 1)
                const sortedByDate = [...projectsData].sort((a, b) => {
                    const dateA = new Date(a.createdAt).getTime();
                    const dateB = new Date(b.createdAt).getTime();
                    return dateA - dateB;
                });
                const idMap = {};
                sortedByDate.forEach((p, i) => {
                    idMap[p.id] = i + 1; // No.1 is oldest
                });

                // 2. Apply IDs to original data
                projectsData.forEach(p => {
                    p._globalIndex = idMap[p.id];
                });
                // è¡¨ç¤ºé †(order)ã§ä¸¦ã³æ›¿ãˆ
                projectsData.sort((a, b) => (a.order || 999) - (b.order || 999));

                // æç”»å®Ÿè¡Œ
                renderFilters();
                displayProjects('all');
                loading.style.display = 'none';

            } catch (e) {
                console.error(e);
                loading.innerHTML = `<p class="error-message">èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ${e.message}</p>`;
            }
        }

        // â–¼ ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒœã‚¿ãƒ³æç”»
        function renderFilters() {
            const div = document.getElementById('filter-section');
            div.innerHTML = `<button class="filter-btn active" onclick="filter('all')">ã™ã¹ã¦</button>` +
                categoriesData.map(c => `<button class="filter-btn" onclick="filter('${c.id}')">${c.name}</button>`).join('');
        }

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é–¢æ•°
        window.filter = (id) => {
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            displayProjects(id);
        };

        // â–¼ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§æç”» (ã‚·ãƒ³ãƒ—ãƒ«ãƒªã‚¹ãƒˆç‰ˆ)
        function displayProjects(catId) {
            const grid = document.getElementById('projects-grid');

            // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã¨ä¸¦ã³æ›¿ãˆ
            let targets = [];
            if (catId === 'all') {
                targets = [...projectsData].sort((a, b) => a._globalIndex - b._globalIndex); // ä½œæˆé †(å¤ã„é †)
            } else {
                targets = projectsData.filter(p => p.categoryId === catId);
                targets.sort((a, b) => (a.order || 999) - (b.order || 999)); // ç®¡ç†è€…æŒ‡å®šé †
            }

            if (targets.length === 0) {
                grid.innerHTML = '<div class="no-projects"><p>ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒã‚ã‚Šã¾ã›ã‚“</p></div>'; return;
            }

            grid.innerHTML = targets.map(p => {
                const deployPlat = platformsData[p.deployPlatformId || p.platformId] || { name: '-', color: '#ccc' };
                const codePlat = platformsData[p.codePlatformId] || null;

                // ãƒªãƒ³ã‚¯ã®æœ‰ç„¡ãƒã‚§ãƒƒã‚¯
                const hasLp = !!p.url;
                const hasSheet = !!p.spreadsheetUrl;
                const hasEdit = !!p.editUrl;
                const hasForm = !!p.formUrl;
                const hasAnyLink = hasLp || hasSheet || hasEdit || hasForm;

                // Creation-numbering (Always Global)
                const displayNum = p._globalIndex;
                // Show number ONLY in 'all' view
                const showNum = (catId === 'all');

                return `
                <div class="project-card">
                    <div class="project-header-row" style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:0.5rem; gap:10px;">
                        <div class="project-title-group" style="flex:1;">
                            <h3 style="margin:0;">
                                ${showNum ? `<span class="display-id">${displayNum}</span>` : ''}
                                ${p.title}
                            </h3>
                            <div class="project-meta" style="margin-top:0.2rem;">
                                ${p.creators
                        ? p.creators.map(c => `<span class="creator-badge">ğŸ‘¤ ${c}</span>`).join('')
                        : `<span class="creator-badge">ğŸ‘¤ ${p.creator || '-'}</span>`}
                                ${codePlat ? `<span class="platform-badge-small" style="background:${codePlat.color}">${codePlat.name}</span>` : ''}
                                <span class="platform-badge-small" style="background:${deployPlat.color}">${deployPlat.name}</span>
                            </div>
                        </div>
                        ${p.releaseDate ? `<div class="release-date" style="font-size:0.85rem; color:#64748b; white-space:nowrap; margin-top:5px;">${p.releaseDate}</div>` : ''}
                    </div>

                    <p class="project-description">${p.description || ''}</p>
                    
                    <div class="project-footer-row">
                        <div class="project-links-group">
                            ${!hasAnyLink ? `<span class="project-link disabled">ãƒªãƒ³ã‚¯ãªã—</span>` : ''}

                            ${hasLp ? `
                                <a href="${p.url}" target="_blank" class="project-link" title="å…¬é–‹ã‚µã‚¤ãƒˆ">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:4px"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line></svg> LP
                                </a>` : ''}

                            ${hasForm ? `
                                <a href="${p.formUrl}" target="_blank" class="project-link link-form" title="ãƒ•ã‚©ãƒ¼ãƒ ">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:4px"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-7"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg> Form
                                </a>` : ''}

                            ${hasSheet ? `
                                <a href="${p.spreadsheetUrl}" target="_blank" class="project-link link-sheet" title="ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆ">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:4px"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="3" y1="9" x2="21" y2="9"></line><line x1="3" y1="15" x2="21" y2="15"></line><line x1="9" y1="3" x2="9" y2="21"></line></svg> Sheet
                                </a>` : ''}

                            ${hasEdit ? `
                                <a href="${p.editUrl}" target="_blank" class="project-link link-edit" title="ç·¨é›†ç”»é¢/ã‚³ãƒ¼ãƒ‰">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:4px"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg> Edit
                                </a>` : ''}
                        </div>

                        ${p.tags ? `
                            <div class="project-tags">
                                ${p.tags.split(',').map(t => `<span class="tag">${t.trim()}</span>`).join('')}
                            </div>` : ''}
                    </div>
                </div>`;
            }).join('');
        }
    </script>
</body>

</html>